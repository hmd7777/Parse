<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Parse | Analyse with Parse</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&family=Inter:wght@400;500&display=swap"
    />
    <link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', path='css/index.css') }}" />
  </head>
  <body>
    <div class="app-shell">
      <header class="top-bar">
        <div class="brand">
          <div class="brand__icon">
            <img
              src="{{ url_for('static', path='images/logo-glyph-light.svg') }}"
              alt="Parse logo accent"
              class="brand__glyph"
            />
            <img
              src="{{ url_for('static', path='images/logo-glyph-dark.svg') }}"
              alt=""
              class="brand__glyph brand__glyph--overlay"
            />
          </div>
          <span class="brand__name">Parse</span>
        </div>
        <div class="user-controls">
          <button class="icon-button" type="button" aria-label="Toggle menu">
            <img
              src="{{ url_for('static', path='images/icon-chevron.svg') }}"
              alt=""
              class="icon-button__icon"
            />
          </button>
          <div class="avatar">AD</div>
        </div>
      </header>

      <main class="workspace">
        <section class="panel conversation">
          <header class="panel__header">
            <h1>Analyse with Parse</h1>
            <img
              src="{{ url_for('static', path='images/icon-dock-right.svg') }}"
              alt=""
              class="panel__header-icon"
            />
          </header>

          <div class="conversation__scroll">
            <article class="card card--request">
              <div class="card__avatar card__avatar--violet">AD</div>
              <p class="card__body">{{ user_prompt }}</p>
            </article>

            <article class="card card--response">
              <header class="card__header">
                <div class="card__brand">
                  <div class="card__brand-icon">
                    <img
                      src="{{ url_for('static', path='images/logo-glyph-light-sm.svg') }}"
                      alt=""
                      class="card__brand-glyph"
                    />
                    <img
                      src="{{ url_for('static', path='images/logo-glyph-dark-sm.svg') }}"
                      alt=""
                      class="card__brand-glyph card__brand-glyph--overlay"
                    />
                  </div>
                  <span class="card__brand-name">Parse</span>
                </div>
              </header>
              <ul class="bullet-list">
                <li>A line chart pulled from FileCities</li>
                <li>A quick breakdown of what the chart shows</li>
                <li>Dark mode background colours</li>
              </ul>
            </article>

            <article class="card card--response">
              <header class="card__header">
                <div class="card__brand">
                  <div class="card__brand-icon">
                    <img
                      src="{{ url_for('static', path='images/logo-glyph-light-sm.svg') }}"
                      alt=""
                      class="card__brand-glyph"
                    />
                    <img
                      src="{{ url_for('static', path='images/logo-glyph-dark-sm.svg') }}"
                      alt=""
                      class="card__brand-glyph card__brand-glyph--overlay"
                    />
                  </div>
                  <span class="card__brand-name">Parse</span>
                </div>
              </header>
              <p class="card__body">
                Here you go !! The charts and analytics are ready. Just let me
                know if you want to tweak anything or dig deeper into FileCities.
              </p>
            </article>
          </div>

          <footer class="composer">
            <span class="composer__placeholder"
              >Ask Parse for more insights...</span
            >
            <form class="composer__actions" id="upload-form">
              <label class="composer__action composer__action--upload" id="upload-trigger">
                <span class="composer__icon-circle">
                  <img
                    src="{{ url_for('static', path='images/icon-attach.svg') }}"
                    alt=""
                    class="composer__icon"
                  />
                </span>
                <span>Attach</span>
                <input
                  id="composer-file-input"
                  class="composer__file-input"
                  type="file"
                  name="file"
                  accept=".pdf,.csv,.xlsx,.xls"
                />
              </label>
            </form>
            <p class="composer__status" id="upload-status">
              {% if file_name %}Uploaded: {{ file_name }}{% endif %}
            </p>
          </footer>
        </section>

        {% block right_panel %}{% endblock %}
      </main>
    </div>
    <script>
      (() => {
        const form = document.getElementById("upload-form");
        const fileInput = document.getElementById("composer-file-input");
        const statusEl = document.getElementById("upload-status");
        if (!form || !fileInput || !statusEl) {
          return;
        }

        const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

        async function pollJob(jobId) {
          while (true) {
            const resp = await fetch(`/jobs/${jobId}`);
            if (!resp.ok) {
              throw new Error("Unable to fetch job status");
            }
            const payload = await resp.json();
            if (payload.status === "SUCCESS") {
              return payload;
            }
            if (payload.status === "FAILURE") {
              throw new Error(payload.error || "Job failed");
            }
            await sleep(1500);
          }
        }

        form.addEventListener("change", async () => {
          const file = fileInput.files[0];
          if (!file) {
            return;
          }
          const data = new FormData();
          data.append("file", file);
          statusEl.textContent = "Uploading…";
          fileInput.disabled = true;
          try {
            const resp = await fetch("/files/upload-async", {
              method: "POST",
              body: data,
            });
            if (!resp.ok) {
              const errText = await resp.text();
              throw new Error(errText || "Upload failed");
            }
            const job = await resp.json();
            statusEl.textContent = "Processing…";
            const result = await pollJob(job.id);
            statusEl.textContent = "Completed!";
            if (result.file_id) {
              window.location.href = `/?file_id=${result.file_id}`;
            }
          } catch (error) {
            statusEl.textContent = `Error: ${error.message}`;
          } finally {
            fileInput.disabled = false;
            fileInput.value = "";
          }
        });
      })();
    </script>
  </body>
</html>
